@model CasaToro.Consulta.Certificados.Web.Models.CertificatesViewModel
<!DOCTYPE html>
<html lang="es-co">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="~/css/style.css"  rel="stylesheet"/>
	<link href="~/css/styleCertificadosTributarios.css" rel="stylesheet" />
    <link href="~/images/icono-web.webp" rel="icon" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
    <title>Proveedores USC</title>
</head>
<body>
    <main class="main-page-container">
        @Html.Partial("_Nav")
        <section class="page-content">
            <div class="certificates-content-header">
                <div class="help">
                    <div class="popup-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="2rem" height="2rem" fill="currentColor" class="bi bi-question-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                            <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286m1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94" />
                        </svg>
                    </div>
                    <div class="popup">
                        <div class="popup-body">
                            <p style="font-size: 16px; color: #333; background-color: transparent; padding: 10px;border-radius: 5px;height:100%">
                                Si notas algún error en los documentos, por favor contáctanos en
                                <a href="mailto:impuestos@casatoro.com" style="color: #007bff; text-decoration: none; font-weight: bold;">
                                    impuestos@casatoro.com
                                </a>
                                y con gusto te ayudaremos.
                            </p>
                        </div>
                    </div>
                </div>

                <h1>Generación de certificados tributarios</h1>
            </div>
            <div class="certificates-content-body">
                <div class="searh-parameters">
                    <div class="search-inputs">
                        <form id="certificateForm">
                            <label class="radio-button">
                                <input type="radio" name="certificateType" value="1" checked>
                                <span class="custom-radio"></span>
                                IVA
                            </label>

                            <label class="radio-button">
                                <input type="radio" name="certificateType" value="2">
                                <span class="custom-radio"></span>
                                ICA
                            </label>

                            <label class="radio-button">
                                <input type="radio" name="certificateType" value="3">
                                <span class="custom-radio"></span>
                                Retención en la fuente
                            </label>

                            <div class="custom-input-group">
                                <label for="company" >Empresa</label>
                                <select id="period" name="companyId">
                                    @foreach(var company in Model.companies){
                                        <option value="@company.IdEmpresa"> @company.Nombre</option>
                                    }
                                </select>
                            </div>

                            <div class="custom-input-group">
                                    <label for="year">Año</label>
                                      <select name="year" id="year">
                                           @foreach(var year in Model.years){
										        <option value="@year"> @year</option>
                                           }
                                    </select>
                                </div>

                                <div class="custom-input-group">
                                    <label for="period">Periodo</label>
                                    <select id="period" name="period">
                                        @foreach(var period in Model.months){
                                            <option value="@period">@period</option>
                                        }
                                    </select>
                                </div>
           
                        </form>
                    </div>
                </div>
                <div class="pdf-viewer">
                    <div class="search-buttons">
                        <button class="custom-button" onclick="generateCertificate()">
                            Generar Certificado
                            <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" style="margin-left:1rem;">
                                <path fill-rule="evenodd" d="M9 2.221V7H4.221a2 2 0 0 1 .365-.5L8.5 2.586A2 2 0 0 1 9 2.22ZM11 2v5a2 2 0 0 1-2 2H4a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2 2 2 0 0 0 2 2h12a2 2 0 0 0 2-2 2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2V4a2 2 0 0 0-2-2h-7Zm-6 9a1 1 0 0 0-1 1v5a1 1 0 1 0 2 0v-1h.5a2.5 2.5 0 0 0 0-5H5Zm1.5 3H6v-1h.5a.5.5 0 0 1 0 1Zm4.5-3a1 1 0 0 0-1 1v5a1 1 0 0 0 1 1h1.376A2.626 2.626 0 0 0 15 15.375v-1.75A2.626 2.626 0 0 0 12.375 11H11Zm1 5v-3h.375a.626.626 0 0 1 .625.626v1.748a.625.625 0 0 1-.626.626H12Zm5-5a1 1 0 0 0-1 1v5a1 1 0 1 0 2 0v-1h1a1 1 0 1 0 0-2h-1v-1h1a1 1 0 1 0 0-2h-2Z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button class="custom-button" onclick='downloadCertificate()'>
                            Descargar
                            <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" style="margin-left:1rem;">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 15v2a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3v-2m-8 1V4m0 12-4-4m4 4 4-4" />
                            </svg>
                        </button>
                    </div>
                    <iframe id="certificateIframe" src=""></iframe>
                </div>
            </div>
        </section>
    </main>
    <!--Alerta-->
    <div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
            <div class="modal-content  border-0 shadow-lg rounded-4">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="alertLabel">
                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16">
                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2" />
                        </svg>
                    </h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    
                    <p id="alertModalBody" class="fs-5"></p>
                </div>
                <div class="modal-footer d-flex justify-content-center">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
    @Html.Partial("_Footer")
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script>
        function generateCertificate() {
              var form = document.getElementById('certificateForm');
              var formData = new FormData(form);

              fetch('/Provider/GenerateCertificate', {
                  method: 'POST',
                  body: formData
              })
              .then(response => response.json())
              .then(data => {
                  if(data.url== ""){
                      showAlert('Lo sentimos no encontramos certificados para tu busqueda');
                      return;
                  }
                  var iframe = document.getElementById('certificateIframe');
                  iframe.src = data.url;
              })
              .catch(error => console.error('Error:', error));
          }

          function downloadCertificate(){
              var iframe = document.getElementById('certificateIframe');
              var url = iframe.src;
              console.log(url);
              console.log(iframe);

              if(!url.includes('Certificados')){
                  showAlert('No hay certificado para descargar');
                  return;
              }

                  fetch(url)
                  .then(response => response.blob())
                  .then(blob => {
                      var link = document.createElement('a');
                      link.href = window.URL.createObjectURL(blob);
                      link.download = url.split('/').pop();
                      link.click();

                      fetch('/Provider/DeleteCertificate', {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json'
                          },
                          body: JSON.stringify(url)
                      })
                      .then(response => response.json())
                      .then(data => {
                          if (data.success) {
                              location.reload();
                          } else {
                              console.error('Error al eliminar el archivo del servidor');
                          }
                      })
                      .catch(error => console.error('Error:', error));
                  })
                  .catch(error => console.error('Error al descargar el archivo:', error));

          }

          function showAlert(message) {
              document.getElementById('alertModalBody').innerText = message;
              var alertModal = new bootstrap.Modal(document.getElementById('alertModal'), {
                  keyboard: false
              });
              alertModal.show();
          }
        
       
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
